<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generátor QR kódu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        .status {
            font-size: 16px;
            margin-top: 10px;
        }
        .error {
            color: red;
        }
        .warning {
            color: orange;
        }
        #downloadContainer {
            display: none;
            margin-top: 10px;
        }
        #downloadLink {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        #qrcode img {
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>Generování QR kódu</h1>

    <!-- Nahrání obrázků -->
    <div>
        <label for="napojovy_listek">Nahrát obrázek nápojového lístku:</label>
        <input type="file" id="napojovy_listek" accept="image/*" onchange="previewImage('napojovy_listek', 'napojovy_listek_preview')">
    </div>
    <div>
        <label for="lineup">Nahrát obrázek lineup festivalu:</label>
        <input type="file" id="lineup" accept="image/*" onchange="previewImage('lineup', 'lineup_preview')">
    </div>

    <!-- Náhledy obrázků -->
    <div id="previewContainer">
        <h3>Náhled obrázků:</h3>
        <img id="napojovy_listek_preview" style="display: none; width: 200px;" alt="Náhled nápojového lístku">
        <img id="lineup_preview" style="display: none; width: 200px;" alt="Náhled lineup festivalu">
    </div>

    <!-- Status -->
    <div id="generateStatus"></div>

    <!-- Tlačítko pro generování QR kódu -->
    <button onclick="generateQR()">Generovat QR kód</button>

    <!-- QR kód -->
    <div id="qrcode"></div>

    <!-- Odkaz pro stažení -->
    <div id="downloadContainer">
        <a id="downloadLink" download="qr_code.png">Stáhnout QR kód</a>
    </div>

    <script>
        function previewImage(inputId, previewId) {
            var file = document.getElementById(inputId).files[0];
            var reader = new FileReader();

            reader.onload = function(e) {
                var preview = document.getElementById(previewId);
                preview.src = e.target.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(file);
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function generateQR() {
            var napojovyListekPreview = document.getElementById("napojovy_listek_preview");
            var lineupPreview = document.getElementById("lineup_preview");
            var statusElement = document.getElementById("generateStatus");

            // Kontrola, zda byly nahrány oba obrázky
            if (!napojovyListekPreview.src || !lineupPreview.src) {
                statusElement.innerHTML = `<div class="error">Prosím, nahrajte oba obrázky před generováním QR kódu.</div>`;
                return;
            }

            statusElement.innerHTML = `<div class="status">Generuji QR kód, prosím čekejte...</div>`;

            try {
                // Vytvoření objektu s daty
                var data = {
                    napojovy_listek_image: napojovyListekPreview.src || '', // Zajištění, že proměnná není undefined
                    lineup_image: lineupPreview.src || '' // Zajištění, že proměnná není undefined
                };

                // Pokud nejsou obrázky, vyhodí to chybu
                if (!data.napojovy_listek_image || !data.lineup_image) {
                    throw new Error('Chybí obrázek nápojového lístku nebo lineup festivalu.');
                }

                console.log("Velikost dat před kompresí:", JSON.stringify(data).length);

                // Komprese dat
                var jsonData = JSON.stringify(data);
                var compressedData = LZString.compressToEncodedURIComponent(jsonData);

                console.log("Velikost dat po kompresi:", compressedData.length);

                // Varování, pokud jsou data příliš velká
                if (compressedData.length > 2000) {
                    statusElement.innerHTML += `<div class="warning">Upozornění: QR kód obsahuje velké množství dat (${formatBytes(compressedData.length)}). Mohou nastat problémy při skenování.</div>`;
                } else {
                    statusElement.innerHTML += `<div class="status">Velikost dat QR kódu: ${formatBytes(compressedData.length)}</div>`;
                }

                // Vytvoření URL s daty
                var baseUrl = window.location.href.split('?')[0]; // Získání základní URL bez parametrů
                var url = baseUrl + "?data=" + compressedData;

                // Nastavení velikosti QR kódu
                var size = 256;

                // Vymazání existujícího QR kódu
                document.getElementById("qrcode").innerHTML = "";

                // Vytvoření nového QR kódu
                var qrcode = new QRCode(document.getElementById("qrcode"), {
                    text: url,
                    width: size,
                    height: size,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H // Nejvyšší úroveň korekce chyb
                });

                // Zpřístupnění tlačítka pro stažení
                setTimeout(function() {
                    var qrImage = document.querySelector("#qrcode img");
                    if (qrImage) {
                        var downloadLink = document.getElementById("downloadLink");
                        downloadLink.href = qrImage.src;
                        document.getElementById("downloadContainer").style.display = "block";
                        statusElement.innerHTML += `<div class="status" style="color: green;">QR kód byl úspěšně vygenerován!</div>`;
                    } else {
                        statusElement.innerHTML += `<div class="error">Nepodařilo se vygenerovat QR kód. Zkuste menší obrázky.</div>`;
                    }
                }, 500);

            } catch (e) {
                console.error("Chyba při generování QR kódu:", e);
                statusElement.innerHTML = `<div class="error">Došlo k chybě při generování QR kódu: ${e.message}</div>`;
            }
        }
    </script>
</body>
</html>
